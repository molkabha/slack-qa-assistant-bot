name: QA Assistant CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 9 * * *'

# Add permissions for security scanning
permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@latest

      - name: Setup ChromeDriver
        uses: nanasess/setup-chromedriver@master

      - name: Install Allure
        run: |
          wget -O allure-2.24.0.tgz https://repo.maven.apache.org/maven2/io/qameta/allure/allure-commandline/2.24.0/allure-commandline-2.24.0.tgz
          tar -zxf allure-2.24.0.tgz -C /opt/
          sudo ln -s /opt/allure-2.24.0/bin/allure /usr/bin/allure

      - name: Create reports directory
        run: mkdir -p reports/allure-results reports/allure-report reports/allure-results-ui reports/allure-report-ui

      - name: Run API tests
        run: |
          pytest tests/test_api.py --alluredir=reports/allure-results --json-report --json-report-file=reports/api_results.json -v
        continue-on-error: true

      - name: Run UI tests
        run: |
          pytest tests/test_ui.py --alluredir=reports/allure-results-ui --json-report --json-report-file=reports/ui_results.json -v
        continue-on-error: true

      - name: Generate Allure Report
        run: |
          allure generate reports/allure-results -o reports/allure-report --clean
          allure generate reports/allure-results-ui -o reports/allure-report-ui --clean
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: reports/

      - name: Deploy to staging
        if: github.ref == 'refs/heads/develop' && success()
        run: echo "Deploying to staging environment"

      - name: Deploy to production
        if: github.ref == 'refs/heads/main' && success()
        run: echo "Deploying to production environment"

      # Fixed Slack notifications - using webhook URL
      - name: Notify Slack on failure
        if: failure() && secrets.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#qa-alerts'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on success
        if: success() && secrets.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#qa-alerts'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Bandit security scan
        run: |
          pip install bandit[sarif]
          bandit -r . -f sarif -o security-results.sarif --exit-zero
        continue-on-error: true

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: security-results.sarif
        continue-on-error: true

      - name: Run dependency check
        run: |
          pip install safety
          safety check --json --output safety-report.json || true
        continue-on-error: true

      - name: Upload dependency report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: safety-report
          path: safety-report.json

  build-and-push:
    needs: [test, security-scan]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && success()
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t qa-assistant:latest .

      - name: Push to registry
        run: echo "Pushing to container registry"
